"use strict";(self.webpackChunkhashicorp_aws=self.webpackChunkhashicorp_aws||[]).push([[6979],{3010:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>s,metadata:()=>t,toc:()=>c});var a=n(5893),r=n(1151);const s={sidebar_position:3,title:"Machine Learning Model in REST API"},l="Deploying Machine Learning Models to Production as REST API",t={id:"machine-learning",title:"Machine Learning Model in REST API",description:"[//]: # (Copyright Jiaqi Liu)",source:"@site/docs/machine-learning.md",sourceDirName:".",slug:"/machine-learning",permalink:"/hashicorp-aws/docs/machine-learning",draft:!1,unlisted:!1,editUrl:"https://github.com/QubitPi/hashicorp-aws/tree/master/docs/docs/machine-learning.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3,title:"Machine Learning Model in REST API"},sidebar:"tutorialSidebar",previous:{title:"Setup",permalink:"/hashicorp-aws/docs/setup"},next:{title:"Elastic Stack (ELK)",permalink:"/hashicorp-aws/docs/elk"}},o={},c=[{value:"MLflow",id:"mlflow",level:2},{value:"General Deployment",id:"general-deployment",level:3},{value:"Generating Machine Learning Models",id:"generating-machine-learning-models",level:3},{value:"AWS Credentials",id:"aws-credentials",level:3},{value:"Installing HashiCorp Packer &amp; Terraform",id:"installing-hashicorp-packer--terraform",level:3},{value:"Getting HashiCorp Deployment Tool",id:"getting-hashicorp-deployment-tool",level:3},{value:"Defining Packer Variables",id:"defining-packer-variables",level:3},{value:"Defining Terraform Variables",id:"defining-terraform-variables",level:3},{value:"Building AMI Image",id:"building-ami-image",level:3},{value:"Deploying to EC2",id:"deploying-to-ec2",level:3},{value:"Deployment via Screwdriver CD",id:"deployment-via-screwdriver-cd",level:2},{value:"Deployment via HACP",id:"deployment-via-hacp",level:2}];function d(e){const i={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(i.h1,{id:"deploying-machine-learning-models-to-production-as-rest-api",children:"Deploying Machine Learning Models to Production as REST API"}),"\n",(0,a.jsx)(i.h2,{id:"mlflow",children:"MLflow"}),"\n",(0,a.jsx)(i.h3,{id:"general-deployment",children:"General Deployment"}),"\n",(0,a.jsx)(i.h3,{id:"generating-machine-learning-models",children:"Generating Machine Learning Models"}),"\n",(0,a.jsxs)(i.p,{children:["hashicorp-aws will deploy an instance\n",(0,a.jsx)(i.a,{href:"https://qubitpi.github.io/mlflow/getting-started/quickstart-2/index.html#running-machine-learning-model-not-managed-by-mlflow-as-rest-api-in-docker-container",children:"running Machine Learning Model NOT Managed by MLflow as REST API in Docker Container"}),"\nand ",(0,a.jsx)(i.a,{href:"https://qubitpi.github.io/mlflow/getting-started/quickstart-2/index.html#serving-the-model-in-docker-container-via-rest-api",children:"expose that API to public"}),"."]}),"\n",(0,a.jsxs)(i.p,{children:["Please follow\n",(0,a.jsx)(i.a,{href:"https://qubitpi.github.io/mlflow/getting-started/quickstart-2/index.html#running-machine-learning-model-not-managed-by-mlflow-as-rest-api-in-docker-container",children:"this dedicated guide"}),"\nto generate the Machine Learning model in a directory ready for use next. We will call this directory\n",(0,a.jsx)(i.strong,{children:"/abs/path/to/mlflow_models/"})," from now on"]}),"\n",(0,a.jsx)(i.admonition,{title:"After model is generated...",type:"info",children:(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:["If the container runs multiple models at different ports, please make sure to add a ",(0,a.jsx)(i.strong,{children:"PORT"})," file containing a port\nnumber only in each sub-dir of ",(0,a.jsx)(i.code,{children:"/abs/path/to/mlflow_models/"})," with one sub-dir holding one model"]}),"\n",(0,a.jsxs)(i.li,{children:["If we need custom module imports in a model, add module.py and a ",(0,a.jsx)(i.code,{children:"__init__.py"})," file to the sub-dir of that model under\n",(0,a.jsx)(i.code,{children:"/abs/path/to/mlflow_models/"})]}),"\n"]})}),"\n",(0,a.jsx)(i.h3,{id:"aws-credentials",children:"AWS Credentials"}),"\n",(0,a.jsx)(i.p,{children:"The following environment variables need to be defined:"}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:(0,a.jsx)(i.a,{href:"setup#aws",children:"AWS_ACCESS_KEY_ID"})}),"\n",(0,a.jsx)(i.li,{children:(0,a.jsx)(i.a,{href:"setup#aws",children:"AWS_SECRET_ACCESS_KEY"})}),"\n"]}),"\n",(0,a.jsx)(i.h3,{id:"installing-hashicorp-packer--terraform",children:"Installing HashiCorp Packer & Terraform"}),"\n",(0,a.jsx)(i.p,{children:"We will go through deployment using Packer & Terraform command line tools which can be installed by following the\ninstructions below:"}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:(0,a.jsx)(i.a,{href:"https://qubitpi.github.io/hashicorp-packer/packer/install",children:"Installing Packer"})}),"\n",(0,a.jsx)(i.li,{children:(0,a.jsx)(i.a,{href:"https://qubitpi.github.io/hashicorp-terraform/terraform/install",children:"Installing Terraform"})}),"\n"]}),"\n",(0,a.jsx)(i.h3,{id:"getting-hashicorp-deployment-tool",children:"Getting HashiCorp Deployment Tool"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{className:"language-console",children:"git clone https://github.com/QubitPi/hashicorp-aws.git\n"})}),"\n",(0,a.jsx)(i.h3,{id:"defining-packer-variables",children:"Defining Packer Variables"}),"\n",(0,a.jsxs)(i.p,{children:["Create a ",(0,a.jsx)(i.a,{href:"https://qubitpi.github.io/hashicorp-packer/packer/guides/hcl/variables#from-a-file",children:"HashiCorp Packer variable values file"})," named ",(0,a.jsx)(i.strong,{children:"aws-mlflow-docker.pkrvars.hcl"})," under\n",(0,a.jsx)(i.strong,{children:(0,a.jsx)(i.a,{href:"https://github.com/QubitPi/hashicorp-aws/tree/master/hashicorp/machine-learning/images/mlflow-docker",children:"hashicorp-aws/hashicorp/machine-learning/images/mlflow-docker"})})," directory with the following contents"]}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{className:"language-hcl",metastring:"title=hashicorp-aws/hashicorp/machine-learning/images/mlflow-docker",children:'aws_image_region = "my-aws-region"\nami_name         = "my-mlflow-models"\ninstance_type    = "<one of t2.micro/t2.small/t2.medium/t2.large/t2.xlarge/t2.2xlarge>"\nml_models_path   = "/abs/path/to/mlflow_models/"\n'})}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"aws_image_region"})," is the ",(0,a.jsx)(i.a,{href:"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.RegionsAndAvailabilityZones.html#Concepts.RegionsAndAvailabilityZones.Availability",children:"image region"})," of ",(0,a.jsx)(i.a,{href:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html",children:"AWS AMI"})]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"ami_name"})," is the published AMI name; it can be arbitrary"]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"instance_type"})," is the recommended ",(0,a.jsx)(i.a,{href:"https://aws.amazon.com/ec2/instance-types/",children:"AWS EC2 instance type"})," running this image"]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"ml_models_path"})," is the directory we made ready ",(0,a.jsx)(i.a,{href:"#generating-machine-learning-models",children:"previously"})]}),"\n"]}),"\n",(0,a.jsx)(i.h3,{id:"defining-terraform-variables",children:"Defining Terraform Variables"}),"\n",(0,a.jsxs)(i.p,{children:["Create a ",(0,a.jsx)(i.a,{href:"https://qubitpi.github.io/hashicorp-terraform/terraform/language/values/variables#variable-definitions-tfvars-files",children:"HashiCorp Terraform variable values file"})," named ",(0,a.jsx)(i.strong,{children:"aws-mlflow-docker.tfvars"})," under\n",(0,a.jsx)(i.strong,{children:(0,a.jsx)(i.a,{href:"https://github.com/QubitPi/hashicorp-aws/tree/master/hashicorp/machine-learning/instances/mlflow-docker",children:"hashicorp-aws/hashicorp/machine-learning/instances/mlflow-docker"})})," directory with the following contents:"]}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{className:"language-hcl",metastring:'title="hashicorp-aws/hashicorp/machine-learning/instances/mlflow-docker/aws-mlflow-docker.tfvars"',children:'aws_deploy_region   = "my-aws-region"\nami_name            = "my-mlflow-models"\ninstance_type       = "<one of t2.micro/t2.small/t2.medium/t2.large/t2.xlarge/t2.2xlarge>"\nec2_instance_name   = "My MLflow models"\nec2_security_groups = ["myKeyPairName"]\n'})}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"aws_deploy_region"})," is the ",(0,a.jsx)(i.a,{href:"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.RegionsAndAvailabilityZones.html#Concepts.RegionsAndAvailabilityZones.Availability",children:"EC2 runtime region"})]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"ami_name"})," is the name of the published AMI; ",(0,a.jsxs)(i.strong,{children:["it must be the same as the ",(0,a.jsx)(i.code,{children:"ami_name"})," in\n",(0,a.jsx)(i.a,{href:"#defining-packer-variables",children:"Packer variable file"})]})]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"instance_type"})," is the chosen ",(0,a.jsx)(i.a,{href:"https://aws.amazon.com/ec2/instance-types/",children:"AWS EC2 instance type"})," at runtime"]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"ec2_instance_name"})," is the deployed EC2 name as appeared in the instance list of AWS console; it can be arbitrary"]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"ec2_security_groups"})," is the ",(0,a.jsx)(i.a,{href:"https://docs.aws.amazon.com/vpc/latest/userguide/vpc-security-groups.html",children:"AWS Security Group"})," ",(0,a.jsx)(i.em,{children:"name"})," (yes, not ID, but name...)"]}),"\n"]}),"\n",(0,a.jsx)(i.h3,{id:"building-ami-image",children:"Building AMI Image"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{className:"language-bash",children:'cd hashicorp-aws/hashicorp/machine-learning/images/mlflow-docker\npacker init .\npacker validate -var "skip_create_ami=true" .\npacker build -var "skip_create_ami=false" .\n'})}),"\n",(0,a.jsx)(i.admonition,{type:"note",children:(0,a.jsx)(i.p,{children:"The packer simply builds a non-model specific AMI"})}),"\n",(0,a.jsx)(i.h3,{id:"deploying-to-ec2",children:"Deploying to EC2"}),"\n",(0,a.jsx)(i.admonition,{type:"caution",children:(0,a.jsxs)(i.p,{children:["Depending on the ",(0,a.jsx)(i.a,{href:"#defining-packer-variables",children:"AMI"})," and ",(0,a.jsx)(i.a,{href:"#defining-terraform-variables",children:"EC2"})," configs, ",(0,a.jsx)(i.strong,{children:"please be aware\nAWS credit charges shall incur after the following commands execute"})]})}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{className:"language-bash",children:"cd ../instances/mlflow-docker\nterraform init\nterraform validate\nterraform apply -auto-approve\n"})}),"\n",(0,a.jsx)(i.h2,{id:"deployment-via-screwdriver-cd",children:"Deployment via Screwdriver CD"}),"\n",(0,a.jsxs)(i.p,{children:["hashicorp-aws also support deployment using ",(0,a.jsx)(i.a,{href:"https://qubitpi.github.io/screwdriver-cd-homepage/",children:"Screwdriver CD"})," with this\n",(0,a.jsx)(i.a,{href:"https://github.com/QubitPi/machine-learning-model-release-definition-templates",children:"Machine Learning model release definition template"})]}),"\n",(0,a.jsx)(i.h2,{id:"deployment-via-hacp",children:"Deployment via HACP"}),"\n",(0,a.jsx)(i.admonition,{type:"tip",children:(0,a.jsx)(i.p,{children:"Please try our HACP platform to deploy a Machine Learning API instance. It gives us one-click experience that helps us\nstand up the API in a minute."})})]})}function h(e={}){const{wrapper:i}={...(0,r.a)(),...e.components};return i?(0,a.jsx)(i,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},1151:(e,i,n)=>{n.d(i,{Z:()=>t,a:()=>l});var a=n(7294);const r={},s=a.createContext(r);function l(e){const i=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function t(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),a.createElement(s.Provider,{value:i},e.children)}}}]);