"use strict";(self.webpackChunkhashicorp_aws=self.webpackChunkhashicorp_aws||[]).push([[4644],{1497:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>d,frontMatter:()=>t,metadata:()=>o,toc:()=>h});var s=i(4848),a=i(8453);const t={sidebar_position:5,title:"Kong API Gateway"},r="Deploying Kong API Gateway",o={id:"kong",title:"Kong API Gateway",description:"[//]: # (Copyright Jiaqi Liu)",source:"@site/docs/kong.md",sourceDirName:".",slug:"/kong",permalink:"/hashicorp-aws/docs/kong",draft:!1,unlisted:!1,editUrl:"https://github.com/QubitPi/hashicorp-aws/tree/master/docs/docs/kong.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5,title:"Kong API Gateway"},sidebar:"tutorialSidebar",previous:{title:"React App",permalink:"/hashicorp-aws/docs/react"},next:{title:"Jersey-Jetty Based Webservice",permalink:"/hashicorp-aws/docs/webservice"}},l={},h=[{value:"General Deployments",id:"general-deployments",level:2},{value:"Defining Packer Variables",id:"defining-packer-variables",level:3},{value:"Defining Terraform Variables",id:"defining-terraform-variables",level:3},{value:"Building AMI Image",id:"building-ami-image",level:3},{value:"Deploying to EC2",id:"deploying-to-ec2",level:3},{value:"Deployment via Screwdriver CD",id:"deployment-via-screwdriver-cd",level:2},{value:"Deployment via HACP",id:"deployment-via-hacp",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"deploying-kong-api-gateway",children:"Deploying Kong API Gateway"}),"\n",(0,s.jsxs)(n.p,{children:["hashicorp-aws deploys ",(0,s.jsx)(n.a,{href:"https://qubitpi.github.io/docs.konghq.com/gateway/latest/",children:"Kong API Gateway"})," in the following way:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Deploys ",(0,s.jsx)(n.a,{href:"https://qubitpi.github.io/docs.konghq.com/gateway/latest/",children:"Kong API Gateway"})," in ",(0,s.jsx)(n.strong,{children:"HTTP"})," mode"]}),"\n",(0,s.jsxs)(n.li,{children:["Deploys a reverse proxy Nginx in front of the ",(0,s.jsx)(n.a,{href:"https://qubitpi.github.io/docs.konghq.com/gateway/latest/",children:"Kong API Gateway"})," in the same EC2 to redirect all HTTPS request to\ngateway's\n",(0,s.jsx)(n.a,{href:"https://qubitpi.github.io/docs.konghq.com/gateway/latest/production/networking/default-ports/",children:"corresponding"})," HTTP\nports"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The diagrams below illustrates the resulting deployment"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Error loading kong-deployment-diagram.png",src:i(7301).A+"",width:"2778",height:"728"})}),"\n",(0,s.jsx)(n.h2,{id:"general-deployments",children:"General Deployments"}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["Please complete the ",(0,s.jsx)(n.a,{href:"setup#setup",children:"general setup"})," before proceeding."]})}),"\n",(0,s.jsxs)(n.admonition,{title:"Supporting HTTPS Protocol",type:"tip",children:[(0,s.jsxs)(n.p,{children:["We offer a ",(0,s.jsx)(n.a,{href:"setup#optional-setup-ssl",children:"Nginx config file"})," template.\n",(0,s.jsx)(n.a,{href:"https://github.com/QubitPi/hashicorp-aws/blob/master/hashicorp/kong/images/nginx-ssl.conf",children:"This template"})," will be used\nby hashicorp-aws by default"]}),(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["hashicorp-aws uses a ",(0,s.jsx)(n.a,{href:"https://github.com/QubitPi/docker-kong",children:"customized fork of docker-kong"})," to\n",(0,s.jsx)(n.a,{href:"https://github.com/QubitPi/docker-kong/pull/1",children:"fully separate the app and SSL"}),",\nand, therefore,"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["the Nginx config needs multiple ",(0,s.jsx)(n.a,{href:"https://www.nginx.com/resources/wiki/start/topics/examples/server_blocks/",children:"servers"}),"\nto ensure all HTTPS ports are mapped to their corresponding HTTP ports as shown in the config snippet below:"]}),"\n",(0,s.jsxs)(n.admonition,{type:"note",children:[(0,s.jsxs)(n.p,{children:["All relevant HTTP and HTTPS ports are listed in\n",(0,s.jsx)(n.a,{href:"https://qubitpi.github.io/docs.konghq.com/gateway/latest/production/networking/default-ports/",children:"Kong's documentation here"}),".\nIn general, our Nginx should **listen on an HTTPS port and ",(0,s.jsx)(n.code,{children:"proxy_pass"})," to an HTTP port. For example, ports 8443 and\n8444 are ",(0,s.jsx)(n.code,{children:"proxy_pass"}),"ed to 8000 and 8001, respectively, both of which are listed in the doc."]}),(0,s.jsx)(n.p,{children:"One special case is HTTP port 8002, which is the Kong manager UI port. hashicorp-aws assigns user specified domain\nto each deployed Kong. Hitting the domain will simply open up a user-friendly UI by this configuration."}),(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Error loading kong-ports-diagram.png",src:i(918).A+"",width:"1662",height:"1064"})})]}),"\n"]}),"\n"]})]}),"\n",(0,s.jsx)(n.p,{children:":::"}),"\n",(0,s.jsx)(n.h3,{id:"defining-packer-variables",children:"Defining Packer Variables"}),"\n",(0,s.jsxs)(n.p,{children:["Create a ",(0,s.jsx)(n.a,{href:"https://qubitpi.github.io/hashicorp-packer/packer/guides/hcl/variables#from-a-file",children:"HashiCorp Packer variable values file"})," named ",(0,s.jsx)(n.strong,{children:"aws-kong.auto.pkrvars.hcl"})," under\n",(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.a,{href:"https://github.com/QubitPi/hashicorp-aws/tree/master/hashicorp/kong/images",children:"hashicorp-aws/hashicorp/kong/images"})})," directory with the following contents:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-hcl",metastring:'title="hashicorp-aws/hashicorp/kong/images/aws-kong.auto.pkrvars.hcl"',children:'aws_image_region       = "us-east-1"\nami_name               = "my-kong-ami"\ninstance_type          = "t2.small"\nssl_cert_file_path     = "/path/to/ssl.crt"\nssl_cert_key_file_path = "/path/to/ssl.key"\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"aws_image_region"})," is the ",(0,s.jsx)(n.a,{href:"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.RegionsAndAvailabilityZones.html#Concepts.RegionsAndAvailabilityZones.Availability",children:"image region"})," where Kong API Gateway ",(0,s.jsx)(n.a,{href:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html",children:"AMI"})," will be published to. The\npublished image will be ",(0,s.jsx)(n.em,{children:"private"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ami_name"})," is the published AMI name; it can be arbitrary"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"instance_type"})," is the ",(0,s.jsx)(n.a,{href:"https://aws.amazon.com/ec2/instance-types/",children:"AWS EC2 instance type"})," running this image"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ssl_cert_file_path"})," is the absolute path or the path relative to ",(0,s.jsx)(n.a,{href:"https://github.com/QubitPi/hashicorp-aws/tree/master/hashicorp/kong/images",children:"hashicorp-aws/hashicorp/kong/images"})," of\nthe ",(0,s.jsx)(n.a,{href:"setup#optional-setup-ssl",children:"SSL certificate file"})," for the Kong API Gateway domain"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ssl_cert_key_file_path"}),"  is the absolute path or the path relative to ",(0,s.jsx)(n.a,{href:"https://github.com/QubitPi/hashicorp-aws/tree/master/hashicorp/kong/images",children:"hashicorp-aws/hashicorp/kong/images"})," of the\n",(0,s.jsx)(n.a,{href:"setup#optional-setup-ssl",children:"SSL certificate key file"})," for the Kong API Gateway domain"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"defining-terraform-variables",children:"Defining Terraform Variables"}),"\n",(0,s.jsxs)(n.p,{children:["Create a ",(0,s.jsx)(n.a,{href:"https://qubitpi.github.io/hashicorp-terraform/terraform/language/values/variables#variable-definitions-tfvars-files",children:"HashiCorp Terraform variable values file"})," named ",(0,s.jsx)(n.strong,{children:"aws-kong.auto.tfvars"})," under\n",(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.a,{href:"https://github.com/QubitPi/hashicorp-aws/tree/master/hashicorp/kong/instances",children:"hashicorp-aws/hashicorp/kong/instances"})})," directory with the following contents:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-hcl",metastring:'title="hashicorp-aws/hashicorp/kong/instances/aws-kong.auto.tfvars"',children:'aws_deploy_region = "us-east-1"\nami_name          = "my-kong-ami"\ninstance_type     = "t2.small"\nec2_instance_name = "My Kong API Gateway"\nsecurity_groups   = ["My Kong API Gateway Security Group"]\ngateway_domain    = "gateway.mycompany.com"\nroute_53_zone_id  = "MBS8YLKZML18VV2E8M8OK"\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"aws_deploy_region"})," is the ",(0,s.jsx)(n.a,{href:"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.RegionsAndAvailabilityZones.html#Concepts.RegionsAndAvailabilityZones.Availability",children:"EC2 runtime region"})," where Kong will be deployed into"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"ami_name"})," is the name of the published AMI; ",(0,s.jsxs)(n.strong,{children:["it must be the same as the ",(0,s.jsx)(n.code,{children:"ami_name"})," in\n",(0,s.jsx)(n.a,{href:"#defining-packer-variables",children:"Packer variable file"})]})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"instance_type"})," is the chosen ",(0,s.jsx)(n.a,{href:"https://aws.amazon.com/ec2/instance-types/",children:"AWS EC2 instance type"})," at runtime"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"ec2_instance_name"})," is the deployed EC2 name as appeared in the instance list of AWS console; it can be arbitrary"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"security_groups"})," is the ",(0,s.jsx)(n.a,{href:"https://docs.aws.amazon.com/vpc/latest/userguide/vpc-security-groups.html",children:"AWS Security Group"})," ",(0,s.jsx)(n.em,{children:"name"})," (yes, not ID, but name...)"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"gateway_domain"})," is the SSL-enabled domain that will serve ",(0,s.jsx)(n.a,{href:"https://qubitpi.github.io/docs.konghq.com/gateway/latest/kong-manager/",children:"Kong manager UI"})]}),"\n",(0,s.jsxs)(n.admonition,{type:"warning",children:[(0,s.jsxs)(n.p,{children:["hashicorp-aws will bind a ",(0,s.jsx)(n.em,{children:"private"})," IP address to this domain for the following reasons:"]}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://serverfault.com/a/967483",children:"AWS security groups works for private IP only for DNS resolving"}),". Services\ninteracting with Kong gateway can use this domain."]}),"\n",(0,s.jsxs)(n.li,{children:["In the case of internal access, for example administrators visiting Kong Manager for config purposes, people can\nstill use ",(0,s.jsx)(n.code,{children:"https://public-dns:port"})]}),"\n"]})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"route_53_zone_id"})," is the AWS Route 53 hosted Zone ID that hosts the domain ",(0,s.jsx)(n.code,{children:"gateway.mycompany.com"})]}),"\n",(0,s.jsxs)(n.admonition,{type:"tip",children:[(0,s.jsx)(n.p,{children:"To find the zone ID in AWS Route 53, we can:"}),(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Sign in to the AWS Management Console"}),"\n",(0,s.jsxs)(n.li,{children:["Open the Route 53 console at ",(0,s.jsx)(n.a,{href:"https://console.aws.amazon.com/route53/",children:"https://console.aws.amazon.com/route53/"})]}),"\n",(0,s.jsx)(n.li,{children:"Select Hosted zones in the navigation pane"}),"\n",(0,s.jsx)(n.li,{children:"Find the requested ID in the top level Hosted Zones summary in the Route 53 section"}),"\n"]})]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"building-ami-image",children:"Building AMI Image"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'cd hashicorp-aws/hashicorp/kong/images\npacker init .\npacker validate -var "skip_create_ami=true" .\npacker build -var "skip_create_ami=false" .\n'})}),"\n",(0,s.jsx)(n.h3,{id:"deploying-to-ec2",children:"Deploying to EC2"}),"\n",(0,s.jsx)(n.admonition,{type:"caution",children:(0,s.jsxs)(n.p,{children:["Depending on the ",(0,s.jsx)(n.a,{href:"#defining-packer-variables",children:"AMI"})," and ",(0,s.jsx)(n.a,{href:"#defining-terraform-variables",children:"EC2"})," configs, ",(0,s.jsx)(n.strong,{children:"please be aware\nAWS credit charges shall incur after the following commands execute"})]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cd ../instances\nterraform init\nterraform validate\nterraform apply -auto-approve\n"})}),"\n",(0,s.jsx)(n.h2,{id:"deployment-via-screwdriver-cd",children:"Deployment via Screwdriver CD"}),"\n",(0,s.jsxs)(n.p,{children:["hashicorp-aws also support deployment using ",(0,s.jsx)(n.a,{href:"https://qubitpi.github.io/screwdriver-cd-homepage/",children:"Screwdriver CD"})," with this ",(0,s.jsx)(n.a,{href:"https://github.com/QubitPi/kong-api-gateway-release-definition-template",children:"Kong API Gateway Release Definition Template"})]}),"\n",(0,s.jsx)(n.h2,{id:"deployment-via-hacp",children:"Deployment via HACP"}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsx)(n.p,{children:"Please try our HACP platform to deploy a Kong instance. It gives us one-click experience that helps us stand up an API\ngateway in a minute."})})]})}function d(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},7301:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/kong-deployment-diagram-0e603dd1e4fb96d8c09f228e1ff31894.png"},918:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/kong-ports-diagram-94dd812152799d6acdc342b76be0588a.png"},8453:(e,n,i)=>{i.d(n,{R:()=>r,x:()=>o});var s=i(6540);const a={},t=s.createContext(a);function r(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);