"use strict";(self.webpackChunkhashicorp_aws=self.webpackChunkhashicorp_aws||[]).push([[1610],{4565:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>c,toc:()=>l});var r=i(3860),t=i(5639);const s={sidebar_position:1,title:"General Deployment"},o=void 0,c={id:"docker-registry-with-ui/index",title:"General Deployment",description:"Quick Start (Manual Deployment without hashicorp-aws)",source:"@site/docs/docker-registry-with-ui/index.md",sourceDirName:"docker-registry-with-ui",slug:"/docker-registry-with-ui/",permalink:"/docs/docker-registry-with-ui/",draft:!1,unlisted:!1,editUrl:"https://github.com/QubitPi/hashistack/tree/master/docs/docs/docker-registry-with-ui/index.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,title:"General Deployment"},sidebar:"tutorialSidebar",previous:{title:"Docker Registry + UI",permalink:"/docs/category/docker-registry--ui"},next:{title:"Sonatype Nexus Repository",permalink:"/docs/category/sonatype-nexus-repository"}},a={},l=[{value:"Quick Start (Manual Deployment without hashicorp-aws)",id:"quick-start-manual-deployment-without-hashicorp-aws",level:2},{value:"Obtain SSL Certificates",id:"obtain-ssl-certificates",level:3},{value:"Set Up Nginx Config",id:"set-up-nginx-config",level:3},{value:"Configuring Authentication (For Both UI Login &amp; <code>docker push</code>)",id:"configuring-authentication-for-both-ui-login--docker-push",level:3},{value:"docker-compose file",id:"docker-compose-file",level:3},{value:"FAQ",id:"faq",level:2},{value:"How to Authenticate <code>docker push</code>?",id:"how-to-authenticate-docker-push",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"quick-start-manual-deployment-without-hashicorp-aws",children:"Quick Start (Manual Deployment without hashicorp-aws)"}),"\n",(0,r.jsx)(n.p,{children:"This section is to give you a taste of what's behind the scene of hashicorp-aws deployment. Let's make some directories\nfirst:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"mkdir my-directory\ncd my-directory\n\nmkdir nginx\nmkdir registry-config\n"})}),"\n",(0,r.jsx)(n.h3,{id:"obtain-ssl-certificates",children:"Obtain SSL Certificates"}),"\n",(0,r.jsxs)(n.p,{children:["Follow the ",(0,r.jsx)(n.a,{href:"../setup#optional-setup-ssl",children:"SSL setup"})," to obtain the ",(0,r.jsx)(n.strong,{children:"fullchain.pem"})," and ",(0,r.jsx)(n.strong,{children:"privkey.pem"})," files and place\nthem under the ",(0,r.jsx)(n.code,{children:"my-directory/nginx"})," directory."]}),"\n",(0,r.jsx)(n.h3,{id:"set-up-nginx-config",children:"Set Up Nginx Config"}),"\n",(0,r.jsxs)(n.p,{children:["Place the following Nginx config file under ",(0,r.jsx)(n.code,{children:"my-directory/nginx"})," directory:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-text",metastring:'title="my-directory/nginx/nginx.conf"',children:'server {\n  listen              443 ssl;\n  ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;\n  ssl_ciphers         HIGH:!aNULL:!MD5;\n  ssl_certificate     /etc/nginx/certs/fullchain.pem;\n  ssl_certificate_key /etc/nginx/certs/privkey.pem;\n  root /usr/share/nginx/html;\n\n  # disable any limits to avoid HTTP 413 for large image uploads\n  client_max_body_size 0;\n\n  location /v2 {\n      # Do not allow connections from docker 1.5 and earlier\n      # docker pre-1.6.0 did not properly set the user agent on ping, catch "Go *" user agents\n      if ($http_user_agent ~ "^(docker\\/1\\.(3|4|5(.[0-9]-dev))|Go ).*$" ) {\n          return 404;\n      }\n      proxy_pass http://registry:5000;\n  }\n}\n\nserver {\n  listen 80;\n  location /  {\n    # Force HTTPS\n    return 301 https://$host$request_uri;\n  }\n}\n'})}),"\n",(0,r.jsxs)(n.h3,{id:"configuring-authentication-for-both-ui-login--docker-push",children:["Configuring Authentication (For Both UI Login & ",(0,r.jsx)(n.code,{children:"docker push"}),")"]}),"\n",(0,r.jsxs)(n.p,{children:["Place the following Registry authentication config file named ",(0,r.jsx)(n.strong,{children:"credentials.yml"})," under ",(0,r.jsx)(n.code,{children:"my-directory/registry-config"}),"\ndirectory:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="my-directory/registry-config/credentials.yml"',children:"version: 0.1\nlog:\n  fields:\n    service: registry\nstorage:\n  delete:\n    enabled: true\n  cache:\n    blobdescriptor: inmemory\n  filesystem:\n    rootdirectory: /var/lib/registry\nhttp:\n  addr: :5000\n  headers:\n    X-Content-Type-Options: [nosniff]\n    Access-Control-Allow-Origin: ['http://localhost']\n    Access-Control-Allow-Methods: ['HEAD', 'GET', 'OPTIONS', 'DELETE']\n    Access-Control-Allow-Headers: ['Authorization', 'Accept']\n    Access-Control-Max-Age: [1728000]\n    Access-Control-Allow-Credentials: [true]\n    Access-Control-Expose-Headers: ['Docker-Content-Digest']\nauth:\n  htpasswd:\n    realm: basic-realm\n    path: /etc/docker/registry/htpasswd\n"})}),"\n",(0,r.jsx)(n.p,{children:"Then generate hashied password using bcrypt"}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Bcrypt",children:"bcrypt"})," is a password-hashing function designed by Niels Provos and David\nMazi\xe8res, based on the Blowfish cipher and presented at\n",(0,r.jsx)(n.a,{href:"https://www.usenix.org/legacy/events/usenix99/provos/provos.pdf",children:"USENIX in 1999"}),". Besides incorporating a\n",(0,r.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Salt_(cryptography)",children:"salt"})," to protect against rainbow\n",(0,r.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Rainbow_table",children:"table attacks"}),", bcrypt is an adaptive function: over time, the iteration\ncount can be increased to make it slower, so it remains resistant to\n",(0,r.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Brute-force_search",children:"brute-force search"})," attacks even with increasing computation power."]})}),"\n",(0,r.jsxs)(n.p,{children:["For Docker Registry, one can\n",(0,r.jsx)(n.a,{href:"https://distribution.qubitpi.org/about/deploying/#native-basic-auth",children:"generate a password file"})," with:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"cd my-directory/registry-config\ndocker run --entrypoint htpasswd httpd:2 -Bbn my-user my-passwd > htpasswd\n"})}),"\n",(0,r.jsx)(n.p,{children:"where"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"my-user"})," is the user for logging into the registry UI"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"my-passwd"})," is the user's password for logging into the registry UI"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The command above will geneate a file called ",(0,r.jsx)(n.strong,{children:"htpasswd"}),", which should be placed under ",(0,r.jsx)(n.code,{children:"my-directory/registry-config"}),"\ndirectory as well"]}),"\n",(0,r.jsx)(n.h3,{id:"docker-compose-file",children:"docker-compose file"}),"\n",(0,r.jsxs)(n.p,{children:["We wire up everything together with a final ",(0,r.jsx)(n.strong,{children:"docker-compose.yml"})," file, which should be put under ",(0,r.jsx)(n.code,{children:"my-directory/"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="my-directory/docker-compose.yml"',children:"version: '2.0'\nservices:\n  registry:\n    image: registry:2.7\n    ports:\n      - 5000:5000\n    volumes:\n      - ./registry-data:/var/lib/registry\n      - ./registry-config/credentials.yml:/etc/docker/registry/config.yml\n      - ./registry-config/htpasswd:/etc/docker/registry/htpasswd\n    networks:\n      - registry-ui-net\n\n  ui:\n    image: joxit/docker-registry-ui:latest\n    ports:\n      - 80:80\n      - 443:443\n    environment:\n      - DELETE_IMAGES=true\n      - REGISTRY_SECURED=true\n      - REGISTRY_TITLE=My Private Docker Registry\n      - NGINX_PROXY_PASS_URL=http://registry:5000\n      - SINGLE_REGISTRY=true\n    volumes:\n      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf\n      - ./nginx/fullchain.pem:/etc/nginx/certs/fullchain.pem\n      - ./nginx/privkey.pem:/etc/nginx/certs/privkey.pem\n    depends_on:\n      - registry\n    networks:\n      - registry-ui-net\n\nnetworks:\n  registry-ui-net:\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["This docker compose is a combination of ",(0,r.jsx)(n.a,{href:"https://github.com/QubitPi/docker-registry-ui/tree/main/examples/ui-as-standalone",children:"Docker Registry Standalone (with credentials)"}),"\nand ",(0,r.jsx)(n.a,{href:"https://github.com/Joxit/docker-registry-ui/tree/main/examples/issue-20",children:"HTTPS supports"})]})}),"\n",(0,r.jsx)(n.p,{children:"At the end of the day, our directory structure should look like the following"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-text",children:"my-directory/\n\u251c\u2500\u2500 nginx/\n\u2502   \u251c\u2500\u2500 nginx.conf\n\u2502   \u251c\u2500\u2500 fullchain.pem\n\u2502   \u2514\u2500\u2500 privkey.pem\n\u251c\u2500\u2500 registry-config/\n\u2502   \u251c\u2500\u2500 credentials.yml\n\u2502   \u2514\u2500\u2500 htpasswd\n\u2514\u2500\u2500 docker-compose.yml\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Make sure we are under ",(0,r.jsx)(n.code,{children:"my-directory/"})," now; then we can start our Registry with"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"docker compose up -d\n"})}),"\n",(0,r.jsxs)(n.p,{children:["If everything sets up correctly, we should be able to view our Registry UI at ",(0,r.jsx)(n.code,{children:"https://registry.mycompany.com"}),":"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Error loading ui.png",src:i(6600).Z+"",width:"1740",height:"606"})}),"\n",(0,r.jsxs)(n.p,{children:["Note that we are supposed to login first with a Username of ",(0,r.jsx)(n.code,{children:"my-user"})," and Password of ",(0,r.jsx)(n.code,{children:"my-passwd"})]}),"\n",(0,r.jsx)(n.h2,{id:"faq",children:"FAQ"}),"\n",(0,r.jsxs)(n.h3,{id:"how-to-authenticate-docker-push",children:["How to Authenticate ",(0,r.jsx)(n.code,{children:"docker push"}),"?"]}),"\n",(0,r.jsx)(n.p,{children:"It is very likely that our CI/CD pipeline will routinely publish Docker images to our just-deploy private registry,\nwhich requires authentication. The CI/CD pipeline can essentially perform the following option to authenticate itself:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"docker login -u=my-user -p=my-passwd https://registry.mycompany.com:5000\n"})}),"\n",(0,r.jsx)(n.p,{children:"where"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"my-user"})," is the user for logging into the registry UI"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"my-passwd"})," is the user's password for logging into the registry UI"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"registry.mycompany.com"})," is the domain of the registry service"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},6600:(e,n,i)=>{i.d(n,{Z:()=>r});const r=i.p+"assets/images/ui-f574ac9461fde7c0cf9f59eb06b18fc4.png"},5639:(e,n,i)=>{i.d(n,{Z:()=>c,a:()=>o});var r=i(1733);const t={},s=r.createContext(t);function o(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);